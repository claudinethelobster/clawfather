# Cursor Task: Fix OAuth Callback UX — Redirect Instead of JSON

## Branch
You are on `feat/mobile-auth-overhaul`. Stay on this branch.

## Repo
/Users/claudine/.openclaw/workspace/clawdfather

## What to change

### 1. `src/routes/auth.ts` — `handleOAuthGitHubCallback`

After the successful `COMMIT` and audit log, the current code calls `apiOk(res, { token, account, expires_at })`.

Replace that with the following logic:

**a) Detect if caller wants JSON:**
```
const wantsJson =
  (req.headers['accept'] ?? '').includes('application/json') ||
  url.searchParams.get('mode') === 'json';
```

**b) If wantsJson → keep existing JSON response (keep `apiOk`).**

**c) If NOT wantsJson (normal browser OAuth flow):**
- Compute `maxAge` = seconds until `expiresAt` (i.e. `Math.floor((expiresAt.getTime() - Date.now()) / 1000)`)
- Set a `Set-Cookie` header:
  ```
  session_token=<token>; HttpOnly; Secure; SameSite=Lax; Path=/; Max-Age=<maxAge>
  ```
  If the request came over non-HTTPS (e.g. localhost dev), omit `Secure` flag. Detect with: check if `req.headers['x-forwarded-proto']` is 'https' OR `config.webDomain` doesn't start with 'localhost'.
- Redirect to `https://${config.webDomain}/` using a 302 redirect:
  ```ts
  res.setHeader('Location', `https://${config.webDomain}/`);
  res.writeHead(302);
  res.end();
  ```
  But if `config.webDomain` starts with `localhost` (dev mode), redirect to `http://localhost:${config.webPort ?? 3000}/` instead.

### 2. `src/auth-middleware.ts` — `authenticate`

Add cookie-based auth fallback. After the existing Bearer token check fails (returns null), also check for `session_token` cookie:

Actually, restructure the function so it:
1. First tries `Authorization: Bearer <token>` header.
2. If not present (no Bearer header), tries to read `session_token` from the `Cookie` header.
   - Parse cookie string: split by `;`, find the part that starts with `session_token=`, extract its value.
3. If neither is found, return 401 as before.
4. Uses the extracted token (from either source) for the DB lookup.

### 3. Add tests: `src/routes/auth.test.ts`

Use Node.js built-in `node:test` and `node:assert` — no external test framework needed (TypeScript will be run via ts-node or we'll just write them as .ts files to be compiled).

Wait — actually, let's use `tsx` for running tests since it's simpler. But tsx may not be installed. Let me think...

Actually: write tests in `src/routes/auth.test.ts` using `node:test` and `node:assert`. The tests should unit-test the logic of the callback handler by mocking the DB calls and fetch.

The tests should cover:
1. **Redirect flow (default)**: callback with no `Accept: application/json` header → response should have a `302` status and `Location` header pointing to the app root, and a `Set-Cookie: session_token=...` header.
2. **JSON flow (Accept: application/json)**: callback with `Accept: application/json` → response should be 200 JSON with `token`, `account`, `expires_at`.
3. **JSON flow (?mode=json)**: callback with `?mode=json` query param → same JSON response.
4. **Cookie auth in middleware**: `authenticate` with `Cookie: session_token=abc123` instead of Bearer header → should resolve to the account.
5. **Missing state**: callback with no state param → 400 error.

Since these tests require mocking DB calls and fetch, use simple inline mocking with module-level override patterns.

**Add a test script to package.json:**
```json
"test": "node --import tsx/esm --test src/routes/auth.test.ts"
```
Wait, the project uses CommonJS (`"module": "commonjs"` in tsconfig). So use ts-node:
```json
"test": "node --require ts-node/register --test src/routes/auth.test.ts"
```

But ts-node may not be installed either. Let me check what's available...

Actually, the simplest approach: write the tests in TypeScript, add `ts-node` and `@types/node` (already installed) as devDependencies, and update package.json scripts.

**Install:** `npm install --save-dev ts-node`

Then test script: `"test": "node --require ts-node/register --test src/routes/auth.test.ts"`

For the tests, since we're mocking complex DB calls, keep the tests focused on the *response behavior* by testing the handler logic with manually constructed mock req/res objects and monkey-patched db/fetch.

### 4. Build & typecheck
Run `npm run build` to ensure TypeScript compiles without errors.

### 5. DO NOT commit — just make all file changes and build. The orchestrator will review and commit.

Actually — wait. The task says to commit. Please:
1. Make all code changes
2. Run `npm run build` to verify
3. Run tests if possible
4. Commit with message: `fix: OAuth callback redirects to app with session cookie instead of returning raw JSON`
5. Push to origin

## Summary of files to modify/create

- `src/routes/auth.ts` — redirect + cookie logic in callback, JSON fallback
- `src/auth-middleware.ts` — add cookie-based auth
- `src/routes/auth.test.ts` — new test file
- `package.json` — add ts-node devDep + test script

## Key constraints

- TypeScript strict mode — no `any` implicit, no ts-errors
- Keep all existing tests/logic working
- The cookie MUST be HttpOnly (not readable by JS) — the frontend should verify auth state via `/api/v1/auth/me` which now supports cookie auth
- Preserve bearer token JSON path for API clients

Go!
