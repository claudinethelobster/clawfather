# Cursor Task: Mobile-First Account-Based SSH Orchestration — Architecture Package

## Goal
Create a comprehensive architecture planning package for the clawdfather project under `docs/planning/`. 
No code changes — produce **7 Markdown planning documents** only.

## Context
Clawdfather is an OpenClaw plugin (TypeScript/Node.js) that today requires the user to SSH in manually 
with agent forwarding before the AI assistant can operate on remote servers. We want to make it 
**mobile-first**: users log in via OAuth (GitHub first), get a per-account Ed25519 keypair provisioned,
save named SSH connections with tested keys, and tap to start agent sessions — no SSH client required.

Current architecture:
- `src/index.ts` — plugin entry, registers SSH server + channel
- `src/sessions.ts` — in-memory session store with ControlMaster cleanup
- `src/ssh-server.ts` — SSH server that intercepts incoming connections
- `src/web-server.ts` — HTTP/WebSocket server for the chat UI
- `src/channel.ts` — OpenClaw messaging channel adapter
- `src/types.ts` — Session, ExecResult, ClawdfatherConfig interfaces
- `ui/` — Single-page app (HTML/CSS/JS)

## Files to Create

Create all files in `docs/planning/`. Use Markdown with headers, tables, code blocks, and callout boxes.
Be specific and practical — no hand-wavy descriptions.

---

### 1. `docs/planning/01-product-ux-flow.md`

**Title: Product & UX Flow Specification**

Include ALL of:

#### 1.1 User Journeys
Write detailed step-by-step flows for:
- **First-time setup**: Open app → OAuth login (GitHub) → account created → keypair generated → shown public key → onboarding complete
- **Add SSH connection**: Tap "+" → enter host/user/port/label → shown one-time install command → user runs it on server → tap "Test Connection" → success/failure → save or retry
- **Test connection** (standalone, after add): Tap connection → "Test" → spinner → success/error with diagnostic
- **Start agent session**: Tap connection → "Start Session" → agent spawns → session ID + URL returned → chat opens
- **Reconnect session**: App foreground → existing session alive → auto-reconnect; OR session expired → user prompted to restart
- **Remove connection**: Long-press connection → "Remove" → confirm dialog → key revoked from server (if accessible) → connection deleted

#### 1.2 Mobile-First UX Constraints
- Screen size, touch targets (min 44px), one-thumb reachability
- No copy-paste of long SSH commands (QR code alternative or "Share" sheet)
- Biometric lock for app access (Face ID / fingerprint)
- Background/foreground app lifecycle and session state
- Push notifications for session events (optional, Phase 2)
- Error messages must be actionable (never just "Error occurred")

#### 1.3 Error & Edge-Case Flows
Cover every meaningful failure:
- OAuth fails / token expired
- Keypair generation fails
- SSH host unreachable / connection refused / auth failed / host key changed
- Session timeout / server crash mid-session
- Concurrent session limit hit
- Revoked/deleted key
- Rate limits hit
- Network loss during session

---

### 2. `docs/planning/02-data-model.md`

**Title: Data Model & Schema Draft**

Write SQL DDL (PostgreSQL-compatible syntax) for all tables, plus notes. Include ALL of:

#### Tables

**accounts**
```sql
CREATE TABLE accounts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  display_name TEXT NOT NULL,
  email TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  last_seen_at TIMESTAMPTZ,
  is_active BOOLEAN NOT NULL DEFAULT TRUE
);
```

**oauth_identities**
```sql
CREATE TABLE oauth_identities (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  account_id UUID NOT NULL REFERENCES accounts(id) ON DELETE CASCADE,
  provider TEXT NOT NULL,                    -- 'github', 'google', etc.
  provider_user_id TEXT NOT NULL,
  provider_username TEXT,
  provider_email TEXT,
  access_token TEXT,                         -- ENCRYPTED AT REST
  refresh_token TEXT,                        -- ENCRYPTED AT REST
  token_expires_at TIMESTAMPTZ,
  scopes TEXT[],
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  UNIQUE (provider, provider_user_id)
);
```

**agent_keypairs**
```sql
CREATE TABLE agent_keypairs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  account_id UUID NOT NULL REFERENCES accounts(id) ON DELETE CASCADE,
  label TEXT NOT NULL DEFAULT 'default',
  algorithm TEXT NOT NULL DEFAULT 'ed25519',
  public_key TEXT NOT NULL,                  -- plain, safe to store
  private_key_enc TEXT NOT NULL,             -- ENCRYPTED AT REST (AES-256-GCM)
  fingerprint TEXT NOT NULL,                 -- SHA-256 base64 fingerprint
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  rotated_at TIMESTAMPTZ,
  revoked_at TIMESTAMPTZ,
  is_active BOOLEAN NOT NULL DEFAULT TRUE,
  UNIQUE (account_id, label)
);
```

**ssh_connections**
```sql
CREATE TABLE ssh_connections (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  account_id UUID NOT NULL REFERENCES accounts(id) ON DELETE CASCADE,
  keypair_id UUID NOT NULL REFERENCES agent_keypairs(id),
  label TEXT NOT NULL,
  host TEXT NOT NULL,
  port INTEGER NOT NULL DEFAULT 22,
  username TEXT NOT NULL,
  host_key_fingerprint TEXT,                 -- pinned after first verified connection
  last_tested_at TIMESTAMPTZ,
  last_test_result TEXT,                     -- 'ok' | 'failed' | 'timeout' | 'host_key_mismatch'
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  deleted_at TIMESTAMPTZ,                    -- soft delete
  UNIQUE (account_id, label)
);
```

**session_leases**
```sql
CREATE TABLE session_leases (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  account_id UUID NOT NULL REFERENCES accounts(id),
  connection_id UUID NOT NULL REFERENCES ssh_connections(id),
  keypair_id UUID NOT NULL REFERENCES agent_keypairs(id),
  status TEXT NOT NULL DEFAULT 'pending',    -- 'pending'|'active'|'closed'|'error'
  agent_session_id TEXT,                     -- OpenClaw agent session ID
  started_at TIMESTAMPTZ,
  closed_at TIMESTAMPTZ,
  close_reason TEXT,                         -- 'user'|'timeout'|'error'|'server_closed'
  last_heartbeat_at TIMESTAMPTZ,
  error_detail TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

**app_sessions** (web/mobile auth sessions)
```sql
CREATE TABLE app_sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  account_id UUID NOT NULL REFERENCES accounts(id) ON DELETE CASCADE,
  token_hash TEXT NOT NULL UNIQUE,           -- SHA-256 of bearer token (NEVER store raw token)
  device_name TEXT,
  ip_address INET,
  user_agent TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  expires_at TIMESTAMPTZ NOT NULL,
  last_used_at TIMESTAMPTZ,
  revoked_at TIMESTAMPTZ
);
```

**audit_log**
```sql
CREATE TABLE audit_log (
  id BIGSERIAL PRIMARY KEY,
  account_id UUID REFERENCES accounts(id),
  actor TEXT,                                -- 'account:<id>' or 'system'
  action TEXT NOT NULL,                      -- e.g. 'connection.test', 'session.start'
  target_type TEXT,                          -- 'ssh_connection', 'session_lease', etc.
  target_id UUID,
  ip_address INET,
  result TEXT,                               -- 'ok' | 'failed'
  detail JSONB,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
-- Partition by month in production for scale
CREATE INDEX audit_log_account_id_idx ON audit_log(account_id);
CREATE INDEX audit_log_created_at_idx ON audit_log(created_at DESC);
```

#### Indexes
List all recommended indexes with justification.

#### Lifecycle State Diagrams
Use ASCII art or tables showing state machines for:
- `session_leases.status`: pending → active → closed/error
- `agent_keypairs`: active → rotated → revoked
- `ssh_connections`: draft (untested) → tested → deleted (soft)

#### Security Notes Per Sensitive Field
Table with columns: field, table, sensitivity, protection mechanism, notes.

---

### 3. `docs/planning/03-api-surface.md`

**Title: API Surface Draft**

Base path: `/api/v1`
Auth: Bearer token in `Authorization` header (except `/auth/*` endpoints)

Include ALL endpoints with method, path, description, auth requirement, rate limit, idempotency note, request body (JSON), and response body examples.

#### Auth & Session Endpoints

**POST /api/v1/auth/oauth/github/start**
- Initiates GitHub OAuth flow, returns redirect URL + state cookie
- Rate limit: 10/minute per IP
- No auth required

**GET /api/v1/auth/oauth/github/callback**
- OAuth callback: exchanges code → access token → creates/links account → issues app session token
- Returns: `{ token: "...", account: { id, display_name, email }, expires_at }`

**DELETE /api/v1/auth/session**
- Revokes current session token
- Auth required

**GET /api/v1/auth/me**
- Returns current account info
- Auth required

#### Key Provisioning Endpoints

**GET /api/v1/keys**
- List all keypairs for account
- Returns: `{ keypairs: [{ id, label, fingerprint, public_key, algorithm, created_at, is_active }] }`

**POST /api/v1/keys**
- Generate a new Ed25519 keypair for the account (or rotate existing)
- Body: `{ label?: string }`
- Returns: `{ keypair: { id, label, fingerprint, public_key, algorithm, created_at } }`
- Idempotent on label (if label exists and active, returns existing)

**GET /api/v1/keys/:id/install-command**
- Returns the one-liner shell command to install the pubkey on a server
- Returns: `{ command: "echo '...' >> ~/.ssh/authorized_keys && chmod 600 ~/.ssh/authorized_keys", public_key: "...", fingerprint: "..." }`

**DELETE /api/v1/keys/:id**
- Revoke a keypair (marks revoked_at, sets is_active=false)
- Cannot delete if active sessions use it

#### SSH Connection CRUD Endpoints

**GET /api/v1/connections**
- List all connections for account
- Returns: `{ connections: [{ id, label, host, port, username, host_key_fingerprint, last_tested_at, last_test_result, created_at }] }`

**POST /api/v1/connections**
- Create a new saved connection
- Body: `{ label, host, port?, username, keypair_id? }`
- Returns: `{ connection: { id, label, host, port, username, keypair_id, created_at } }`

**PATCH /api/v1/connections/:id**
- Update connection label/host/port/username
- Cannot change host if active session

**DELETE /api/v1/connections/:id**
- Soft-delete connection (sets deleted_at)
- Fails if active session

**POST /api/v1/connections/:id/test**
- Test SSH connectivity using stored keypair
- Spawns a short SSH session (echo test), pins host key if new
- Body: `{ accept_host_key?: boolean }` (if host_key_fingerprint mismatch, returns 409 with new fingerprint)
- Returns: `{ result: "ok"|"failed"|"timeout"|"host_key_changed", latency_ms: 123, message: "..." }`
- Rate limit: 5/minute per connection

#### Session Lifecycle Endpoints

**POST /api/v1/sessions**
- Start an agent session for a connection
- Body: `{ connection_id: "..." }`
- Returns: `{ session: { id, status, agent_session_id, started_at, chat_url } }`
- Rate limit: 10/hour per account

**GET /api/v1/sessions/:id**
- Get session status + metadata
- Returns: `{ session: { id, status, connection: {...}, started_at, last_heartbeat_at, close_reason } }`

**DELETE /api/v1/sessions/:id**
- Close an active session gracefully
- Returns: `{ session: { id, status: "closed", closed_at, close_reason: "user" } }`

**GET /api/v1/sessions**
- List sessions for account (paginated)
- Query params: `?status=active&limit=20&offset=0`

#### Audit Log Endpoint

**GET /api/v1/audit**
- Paginated audit log for account
- Query: `?limit=50&before=<ISO timestamp>&action=session.start`

---

### 4. `docs/planning/04-security-model.md`

**Title: Security Model & Threat Model**

Include ALL of:

#### 4.1 Key Management Strategy
- Ed25519 keypair generation: use Node.js `crypto.generateKeyPair('ed25519')` — never user-controlled entropy
- Private key encryption: AES-256-GCM with a per-account KEK (Key Encryption Key) derived from server-side master key + account_id using HKDF
- KEK rotation: master key stored in environment variable or HSM (AWS KMS / GCP KMS recommended for production); rotate via dual-key approach
- Key rotation workflow: generate new pair → install on all connections → verify → mark old as rotated (keep for 7 days for active session teardown) → revoke
- Revocation: set revoked_at + is_active=false; SSH sessions using revoked key are terminated within 60 seconds via heartbeat check

#### 4.2 Host Key Verification Policy
- First connection: TOFU (Trust On First Use) — fingerprint shown to user who must explicitly approve
- Pinned thereafter in `ssh_connections.host_key_fingerprint`
- On mismatch: **refuse connection**, return 409 with old_fingerprint vs new_fingerprint, require explicit user acceptance with re-pin
- Known-hosts cache: maintained server-side per connection; never `StrictHostKeyChecking=no` in production

#### 4.3 Password Handling Policy
- **No password SSH auth in v1.** Ed25519 keys only.
- If password fallback is requested in Phase 2: encrypt with AES-256-GCM (same KEK scheme), never log, never return in API responses, TTL max 90 days, require re-entry after rotation

#### 4.4 OAuth Token/Session Hardening
- State parameter: 32-byte CSPRNG, stored in signed HttpOnly cookie, validated on callback (CSRF protection)
- PKCE: code_challenge/code_verifier for public clients
- App session tokens: 32-byte CSPRNG, stored as SHA-256 hash only in DB
- Session TTL: 30 days default, sliding expiry on activity
- Brute force: rate limit OAuth callback to 20/hour per IP, lock account after 10 failed token validations
- Replay: nonces on all state-changing endpoints; idempotency keys on session start

#### 4.5 Audit Logging & Incident Response
- Log all: auth events, key generation/rotation/revocation, connection add/test/delete, session start/stop, API errors
- Format: structured JSON to append-only log + DB (audit_log table)
- Retention: 90 days hot in DB, archive to S3/GCS for 1 year
- Incident hooks: on >5 failed auth in 10 min → alert + temporary account lock; on unknown host key → alert

#### 4.6 Threat Model Table
| Threat | Vector | Mitigation |
|--------|--------|------------|
| Private key theft | DB breach | Keys encrypted at rest with KEK; KEK in HSM |
| Session hijack | Bearer token theft | Short TTL, HTTPS only, token stored hashed |
| MITM / host key swap | Network | Host key pinning + TOFU + reject on mismatch |
| OAuth token abuse | Provider breach | Minimal scopes, token not stored raw |
| Brute force API | Unauthenticated endpoints | Rate limits + IP ban + CAPTCHA |
| Replay attack | Captured request | Nonces + HTTPS |
| SSH key misuse | Compromised server | Per-account keys, revocation, audit log |
| Concurrent session abuse | Multiple clients | Session limit per account (configurable) |

---

### 5. `docs/planning/05-execution-architecture.md`

**Title: Execution Architecture**

Include ALL of:

#### 5.1 Agent Runtime Binding
- When session starts: API creates `session_lease` record → spawns OpenClaw agent session with connection metadata in context payload
- Agent receives: `{ connection_id, host, port, username, keypair_id, session_lease_id }`
- Agent establishes SSH ControlMaster using decrypted private key (temp file with 600 perms, deleted after ControlMaster established)
- ControlMaster socket path: `/tmp/clawdfather/{session_lease_id}.sock`
- All `exec` tool calls prefixed with SSH ControlMaster command via env injection

#### 5.2 Process Model
- SSH ControlMaster process is a child process of the API server (or agent runtime)
- `ssh -N -o ControlMaster=yes -o ControlPath=<sock> -i <key_file> user@host`
- On agent session end: API receives `session.closed` event → send `ssh -O exit` to ControlMaster socket → unlink socket → mark session_lease closed
- Orphan cleanup: background job every 60s checks session_leases with status=active and last_heartbeat >2min → force-close ControlMaster + update status

#### 5.3 Reconnect Semantics
- Session IDs are durable (UUID in session_leases)
- Client can re-attach to an active session by ID (GET /api/v1/sessions/:id returns chat_url)
- On app foreground: check all active sessions → refresh WebSocket connection to existing sessions
- Session expiry: configurable (default 30 min idle), not wall-clock
- Reconnect window: up to 5 min after last heartbeat before server tears down (grace period)

#### 5.4 Timeout Strategy
- SSH connect timeout: 10 seconds
- SSH keepalive: `ServerAliveInterval=30 ServerAliveCountMax=3` (90s total)
- Agent session idle timeout: 30 min (configurable per account)
- API request timeout: 30 seconds
- Connection test timeout: 15 seconds

#### 5.5 Observability Requirements
- Structured logs: every SSH event (connect, exec, disconnect, error) with session_lease_id, account_id, connection_id
- Metrics (Prometheus-compatible): active_sessions gauge, session_start_total counter, session_error_total counter, ssh_connect_latency_ms histogram
- Health endpoint: `GET /health` returns `{ status: "ok", active_sessions: N, db: "ok" }`
- Tracing: OpenTelemetry spans for SSH connect + exec (Phase 2)
- Alerting: Grafana/Datadog rules for error rate > 5%, latency p99 > 5s

---

### 6. `docs/planning/06-phased-implementation.md`

**Title: Phased Implementation Plan**

Include ALL of:

#### Phase 0 — Foundation (Weeks 1-2)
**Goal:** Infrastructure and auth, no SSH yet.
- Database schema migration (all tables from doc 02)
- GitHub OAuth flow (start + callback + account create/link)
- App session token issuance + validation middleware
- `GET /api/v1/auth/me`
- Unit tests for auth flow + token hashing
- **Acceptance criteria:** Can log in with GitHub, get a token, call /me

#### Phase 1 — Key Provisioning + Connection Management (Weeks 3-5)
**Goal:** Users can add, test, and manage SSH connections.
- Ed25519 keypair generation + encrypted storage
- Install-command endpoint
- SSH connection CRUD
- Connection test endpoint (real SSH handshake)
- Host key TOFU + pinning
- Audit log for all key + connection events
- Basic mobile UI: login, connections list, add connection, test connection
- **Acceptance criteria:** Can add a connection, run install command on server, test succeeds, connection saved

#### Phase 2 — Session Lifecycle (Weeks 6-8)
**Goal:** Full end-to-end agent sessions from mobile.
- Session start endpoint (spawn agent + ControlMaster)
- Session heartbeat + cleanup
- Session close endpoint
- WebSocket re-attach on reconnect
- Mobile UI: session view, reconnect flow
- Observability: metrics + structured logs
- **Acceptance criteria:** Tap to start session → AI chat works → close app → session cleans up

#### Phase 3 — Hardening + Migration (Weeks 9-11)
**Goal:** Production-ready, migrate existing SSH-first users.
- Push notifications (session events)
- Key rotation workflow + UI
- Rate limiting + brute-force mitigations
- E2E test suite
- Migration guide: SSH-first users add a connection + test, old SSH entrypoint deprecated
- **Acceptance criteria:** All security mitigations active, old flow deprecated, migration tested

#### Migration Strategy from SSH-First Flow
- v1 SSH-first flow continues working during Phase 0-2
- Phase 3: add banner in SSH welcome prompting users to migrate
- Phase 3+: deprecate SSH-first in favor of OAuth flow
- Existing sessions: no migration needed (they're ephemeral)

#### Testing Plan
| Level | Tool | Coverage Target |
|-------|------|----------------|
| Unit | Vitest/Jest | Auth, crypto, key gen, state machines |
| Integration | Supertest | All API endpoints with real DB (test schema) |
| E2E | Playwright | Full mobile flow: login → add → test → session |
| Manual | Test device | iOS + Android on real network |
| Security | OWASP ZAP | Auth endpoints, injection, headers |

---

### 7. `docs/planning/07-engineering-breakdown.md`

**Title: PR-Ready Engineering Breakdown**

Include ALL of:

#### Epic Map
List epics with child issues, estimates, and dependencies:

**Epic 1: Auth & Account System** (Phase 0, ~1 week)
- Issue 1: DB schema migrations (accounts, oauth_identities, app_sessions, audit_log) — 3 points
- Issue 2: GitHub OAuth flow (start + callback) — 5 points
- Issue 3: Session token middleware (hash, validate, revoke) — 3 points
- Issue 4: /api/v1/auth/me endpoint + tests — 1 point
- Depends on: DB setup

**Epic 2: Key Provisioning** (Phase 1, ~1 week)
- Issue 5: Keypair generation + AES-256-GCM encryption at rest — 5 points
- Issue 6: GET /api/v1/keys, POST /api/v1/keys — 3 points
- Issue 7: GET /api/v1/keys/:id/install-command — 2 points
- Issue 8: DELETE /api/v1/keys/:id — 2 points
- Depends on: Epic 1

**Epic 3: SSH Connection Management** (Phase 1, ~1.5 weeks)
- Issue 9: Connection CRUD endpoints + schema — 5 points
- Issue 10: Connection test (real SSH + host key TOFU/pin) — 8 points
- Issue 11: Host key mismatch flow (409 + re-pin) — 3 points
- Issue 12: Soft delete + cascade — 2 points
- Depends on: Epic 2

**Epic 4: Session Lifecycle** (Phase 2, ~2 weeks)
- Issue 13: Session start (spawn agent + ControlMaster) — 13 points
- Issue 14: Session heartbeat + cleanup job — 5 points
- Issue 15: Session close endpoint — 3 points
- Issue 16: WebSocket re-attach for reconnect — 5 points
- Depends on: Epic 3

**Epic 5: Mobile UI** (Phases 1-2, ~3 weeks, parallel)
- Issue 17: Auth screen (GitHub OAuth web view) — 5 points
- Issue 18: Connections list + add connection form — 5 points
- Issue 19: Test connection UI + TOFU confirmation — 5 points
- Issue 20: Session view + chat integration — 8 points
- Issue 21: Reconnect flow UI — 3 points
- Depends on: Epics 1-4 (API-first, can mock)

**Epic 6: Security & Hardening** (Phase 3, ~1.5 weeks)
- Issue 22: Rate limiting middleware — 3 points
- Issue 23: Brute-force mitigation + account lock — 5 points
- Issue 24: Key rotation workflow — 5 points
- Issue 25: Audit log hardening + retention policy — 3 points
- Issue 26: OWASP ZAP scan + fixes — 5 points
- Depends on: Epics 1-5

**Epic 7: Migration & Deprecation** (Phase 3, ~1 week)
- Issue 27: SSH-first deprecation banner — 2 points
- Issue 28: Migration docs + runbook — 3 points
- Issue 29: E2E test suite — 8 points
- Depends on: Epics 1-6

#### Dependency Map (ASCII)
```
Epic 1 (Auth)
    └── Epic 2 (Keys)
            └── Epic 3 (Connections)
                    └── Epic 4 (Sessions)
                            └── Epic 7 (Migration)
Epic 5 (Mobile UI) [parallel, API-mocked first]
Epic 6 (Hardening) [Phase 3, after core complete]
```

#### Total Estimate
- Total: ~107 story points
- Team of 2 engineers: ~11 weeks
- With 1 engineer: ~18-20 weeks

#### Risks & Mitigations
| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| SSH ControlMaster on server OS varies | Medium | High | Test on Ubuntu, Debian, RHEL; document known issues |
| Key encryption KMS integration delays | Low | High | Start with env-var KEK, add KMS in Phase 3 |
| Mobile OAuth WebView restrictions (iOS) | Medium | Medium | Use ASWebAuthenticationSession on iOS |
| Host key TOFU UX confusion | High | Medium | Clear copy + screenshots in UI, help link |
| Session orphan leak (ControlMaster) | Low | High | 60s cleanup job + process monitoring |
| GitHub OAuth rate limits | Low | Low | Cache OAuth user info, don't re-fetch on every request |
| DB migration conflicts | Low | Medium | Sequential migration files, CI gate |

---

## Instructions for Cursor

1. Create ALL 7 files listed above in `docs/planning/`
2. Produce complete, self-contained Markdown with all content specified — do NOT produce placeholder sections or "TBD"
3. Make the content specific, detailed, and implementation-ready (engineers can read these and start immediately)
4. Include all SQL DDL, JSON examples, and ASCII diagrams as specified
5. Add a `docs/planning/README.md` index file that links all 7 docs with one-line descriptions
6. Do NOT modify any source code files
7. Do NOT create any files outside `docs/planning/`
